{% load static %}
<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="{% static 'dashboard.css' %}">
<link rel="stylesheet" type="text/css" href="{% static '_sidebar.css' %}">
</head>
<body>
    {% include '_sidebar.html' with is_admin=True %}
    <h1>Welcome back Admin, <br>{{ username }}!</h1>
    <h3>These posts await your review</h3>
    <div class="container">
        <div class="header">
            <div class="headertitles">Username</div>
            <div class="headertitles">Priority</div>
            <div class="headertitles">Date Submitted</div>
        </div>
        {% for post in posts %}
            {% if post.status == "pending" %}
                <div class="row" onclick="showModal(this)" data-post-id="{{ post.postId }}" data-username="{% if post.isAnonymous %}Anonymous{% else %}{{ post.member.username }}{% endif %}" data-content="{{ post.content }}" data-priority="{{ post.priorityLevel }}" data-date="{{ post.timeStamp }}" data-status="{{ post.status }}">
                    <div class="user-info">
                        {% if post.isAnonymous %}
                            <img src="{% static 'images/anonymous_avatar.jpg' %}" class="avatar" alt="Anonymous avatar">
                        {% elif post.member.profile_picture %}
                            <img src="{{ post.member.profile_picture.url }}" class="avatar" alt="User avatar">
                        {% else %}
                            <img src="{% static 'images/default_avatar.png' %}" class="avatar" alt="Default avatar">
                        {% endif %}
                        <div>
                            <span class="name">{% if post.isAnonymous %}Anonymous{% else %}{{ post.member.username }}{% endif %}</span>
                        </div>
                    </div>
                    <div class="priority-{{ post.priorityLevel|lower }}">{{ post.priorityLevel }}</div>
                    <div class="timeStamp">{{ post.timeStamp }}</div>
                </div>
                <div class="divider"></div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- The Modal -->
    <div id="myModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="modalDetails"></div>
        <div class="modal-buttons">
          <button id="approveButton">Approve</button>
          <button id="rejectButton">Reject</button>
        </div>
      </div>
    </div>

<script>
function showModal(element) {
  // Fetch post details from data attributes
  const postId = element.getAttribute('data-post-id');
  const username = element.getAttribute('data-username');
  const content = element.getAttribute('data-content');
  const priority = element.getAttribute('data-priority');
  const dateSubmitted = element.getAttribute('data-date');
  const status = element.getAttribute('data-status');

  // Populate modal with post details
  document.getElementById('modalDetails').innerHTML = `
    <h2>Post Details</h2>
    <p><strong>Username:</strong> ${username}</p>
    <p><strong>Content:</strong> ${content}</p>
    <p><strong>Priority:</strong> ${priority}</p>
    <p><strong>Date Submitted:</strong> ${dateSubmitted}</p>
    <p><strong>Status:</strong> ${status}</p>
    <input type="hidden" id="postId" value="${postId}">
  `;

  // Show the modal
  document.getElementById('myModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('myModal').style.display = 'none';
}

// Close the modal when clicking outside of it
window.onclick = function(event) {
  if (event.target == document.getElementById('myModal')) {
    closeModal();
  }
}

// Add event listener to the approve button
document.getElementById('approveButton').addEventListener('click', function() {
  const postId = document.getElementById('postId').value;
  fetch(`/custom-admin/update_post_status/${postId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ status: 'approved' })  // Change status to 'approved'
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      closeModal();
      location.reload(); // Reload the page to reflect the changes
    } else {
      alert('Error approving post');
    }
  });
});

// Add event listener to the reject button
document.getElementById('rejectButton').addEventListener('click', function() {
  const postId = document.getElementById('postId').value;
  fetch(`/custom-admin/update_post_status/${postId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ status: 'rejected' })  // Change status to 'rejected'
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      closeModal();
      location.reload(); // Reload the page to reflect the changes
    } else {
      alert('Error rejecting post');
    }
  });
});
</script>
</body>
</html>